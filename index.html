<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Vocabulary Battle Game</title>
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    /* Nền huyền bí hơn: màu đen không gian với các ngôi sao */
    background: #0a0a1a; /* Màu nền tối */
    background-image: radial-gradient(circle at top left, #2c3e50 0%, #0a0a1a 70%),
                      url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZmlsdGVyIGlkPSJzdGFycyI+CiAgICA8ZnVuY3RUYWJsZSB0eXBlPSJkaXNjb25lIj4KICAgICAgPGZlRnVuY3QgY29sb3ItY29tcG9uZW50cz0icmFkZ2IiPgogICAgICAgIDxmdW5jQ29tcG9uZW50IHR5cGU9ImxpbmVhciIgc2xvcGU9IjAiIGludGVyY2VwdD0iMC41IiAvPgogICAgICAgIDxmdW5jQ29tcG9uZW50IHR5cGU9ImxpbmVhciIgc2xvcGU9IjAiIGludGVyY2VwdD0iMC41IiAvPgogICAgICAgIDxmdW5jQ29tcG9uZW50IHR5cGU9ImxpbmVhciIgc2xvcGU9IjAiIGludGVyY2VwdD0iMC41IiAvPgogICAgICAgIDxmdW5jQ29tcG9uZW50IHR5cGU9ImxpbmVhciIgc2xvcGU9IjAiIGludGVyY2VwdD0iMC41IiAvPgogICAgICA8L2ZlRnVuY3Q+CiAgICA8ZmVGaWx0ZXIgY29sb3ItbWF0cml4PSJzYXR1cmF0ZSAxLjUiLz4KICAgIDxmZVR1cmJ1bGVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSIwLjcgMC43IiBudW1PY3RhdmVzPSI0IiBzdGl0Y2hUaWxlcz0ic3RpdGNoIiAvPgogICAgPGZlQ29sb3JNYXRyaXggdHlwZT0ic2F0dXJhdGUiIHZhbHVlcz0iMC41IiAvPgogICAgPGZlQ29tcG9zaXRlIGluPSJTb3VyY2VHcmFwaGljIiBpbjI9InR1cmJ1bGVuY2UiIG9wZXJhdG9yPSJsaWdodGVuIiAvPgogIDwvZmlsdGVyPgogIDxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbHRlcj0idXJsKCNzdGFycykiIG9wYWNpdHk9IjAuMiIgLz4KPC9zdmc+'); /* Hiệu ứng sao */
    background-attachment: fixed; /* Giữ nền cố định khi cuộn */
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    color: #e0e0e0; /* Màu chữ sáng hơn để dễ đọc trên nền tối */
    padding: 20px;
    box-sizing: border-box;
    transition: background-color 0.1s ease-out;
  }
  h1, h2 {
    margin-bottom: 1rem;
    color: #f0f0f0; /* Màu chữ sáng hơn cho tiêu đề */
    text-shadow: 0 0 8px rgba(255,255,255,0.3); /* Hiệu ứng phát sáng nhẹ */
  }
  .centered {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
  }
  button {
    cursor: pointer;
    border-radius: 12px;
    border: 2px solid #666; /* Viền nút tối hơn */
    padding: 10px 20px;
    font-size: 1.1rem;
    background: #333; /* Nền nút tối hơn */
    color: #eee; /* Chữ nút sáng hơn */
    transition: 0.3s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }
  button:hover {
    background: #555; /* Nền nút sáng hơn khi hover */
    color: white;
    box-shadow: 0 4px 8px rgba(0,0,0,0.5);
  }

  /* Character Selection Area Enhancements */
  #character-selection, #opponent-selection { /* Áp dụng chung cho cả chọn nhân vật và đối thủ */
    margin-top: 20px;
    width: 100%;
    max-width: 900px;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    perspective: 1000px;
  }

  .character-carousel, .opponent-carousel { /* Áp dụng chung cho carousel */
    display: flex;
    justify-content: center;
    gap: 30px;
    flex-wrap: wrap;
    margin-bottom: 30px;
  }

  .character, .opponent { /* Áp dụng chung cho thẻ chọn */
    cursor: pointer;
    border-radius: 15px;
    border: 3px solid transparent;
    overflow: hidden;
    width: 160px;
    height: 220px;
    text-align: center;
    background: rgba(255,255,255,0.1); /* Nền trong suốt hơn */
    backdrop-filter: blur(5px); /* Hiệu ứng mờ nền */
    transition: border-color 0.3s, transform 0.4s ease-out, box-shadow 0.3s;
    box-shadow: 0 6px 12px rgba(0,0,0,0.4); /* Bóng đổ đậm hơn */
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 10px;
    transform-style: preserve-3d;
  }

  .character:hover, .opponent:hover {
    transform: translateY(-10px) rotateY(15deg);
    box-shadow: 0 10px 20px rgba(0,0,0,0.6);
  }

  .character.selected {
    border-color: #00bfff; /* Màu viền chọn nhân vật sáng hơn (xanh) */
    box-shadow: 0 8px 16px rgba(0, 191, 255, 0.6); /* Bóng đổ phát sáng xanh */
    transform: translateY(-15px) rotateY(0deg) scale(1.05);
  }

  .opponent.selected {
    border-color: #fa0000; /* Màu viền chọn đối thủ sáng hơn (đỏ cam) */
    box-shadow: 0 8px 16px rgba(255, 0, 0, 0.653); /* Bóng đổ phát sáng đỏ cam */
    transform: translateY(-15px) rotateY(0deg) scale(1.05);
  }

  .character img, .opponent img {
    width: 100%;
    height: 150px;
    object-fit: contain;
    background: rgba(0,0,0,0.2); /* Nền ảnh tối hơn */
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
  }
  .character div, .opponent div {
    font-weight: bold;
    font-size: 1.1em;
    color: #eee; /* Chữ sáng hơn */
    margin-top: 10px;
  }

  /* Skill Info Display */
  #skill-info-display {
    background: rgba(0,0,0,0.7); /* Nền tối hơn, trong suốt */
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.5);
    width: 80%;
    max-width: 600px;
    margin-top: 20px;
    text-align: left;
    display: none;
    border: 1px solid #444; /* Viền tối hơn */
    color: #e0e0e0; /* Chữ sáng hơn */
  }
  #skill-info-display h3 {
    color: #00bfff; /* Màu tiêu đề sáng hơn */
    margin-top: 0;
    font-size: 1.5rem;
  }
  #skill-info-display p {
    font-size: 1.1rem;
    line-height: 1.6;
    color: #ccc; /* Chữ sáng hơn */
  }

  /* Opponent Skill Info Display (mới) */
  #opponent-skill-info-display {
    background: rgba(0,0,0,0.7);
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.5);
    width: 80%;
    max-width: 600px;
    margin-top: 20px;
    text-align: left;
    display: none;
    border: 1px solid #444;
    color: #e0e0e0;
  }
  #opponent-skill-info-display h3 {
    color: #ff4500; /* Màu tiêu đề đỏ cam */
    margin-top: 0;
    font-size: 1.5rem;
  }
  #opponent-skill-info-display p {
    font-size: 1.1rem;
    line-height: 1.6;
    color: #ccc;
  }


  /* Topic Selection Enhancements */
  #topic-selection {
    display: none;
    margin-top: 20px;
    width: 100%;
    max-width: 800px;
    text-align: center;
    background: rgba(0,0,0,0.7); /* Nền tối hơn, trong suốt */
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.5);
  }
  #topic-selection h2 {
    color: #00bfff; /* Màu tiêu đề sáng hơn */
    margin-bottom: 25px;
    font-size: 2rem;
    text-shadow: 0 0 8px rgba(0, 191, 255, 0.5);
  }
  #topic-selection .centered {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
  }
  #topic-selection button {
    width: 100%;
    padding: 15px 10px;
    font-size: 1.2rem;
    font-weight: bold;
    color: #eee;
    background: linear-gradient(145deg, #222, #444); /* Gradient tối hơn */
    border: none;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    transition: all 0.2s ease-in-out;
  }
  #topic-selection button:hover {
    background: linear-gradient(145deg, #444, #666);
    color: #00bfff;
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.5);
  }
  #topic-selection button:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }


  /* Styles for the new game arena */
  #game-arena {
    margin-top: 20px;
    width: 100%;
    max-width: 900px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    display: none;
  }

  #question-area {
    width: 100%;
    margin-top: 0;
    text-align: center;
    background: rgba(0,0,0,0.7); /* Nền tối hơn, trong suốt */
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.5);
    border: 1px solid #444;
    color: #e0e0e0; /* Chữ sáng hơn */
  }
  #current-turn {
    font-size: 1.4rem;
    font-weight: bold;
    margin-bottom: 15px;
    color: #00bfff; /* Màu chữ sáng hơn */
  }
  #quiz-question-new {
    margin-bottom: 20px;
    font-size: 1.6rem;
    text-align: center;
    color: #f0f0f0; /* Chữ sáng hơn */
  }
  #quiz-question-new img {
    max-width: 250px;
    max-height: 250px;
    margin-bottom: 15px;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  }
  #answer-input-new {
    width: 80%;
    max-width: 400px;
    padding: 12px;
    font-size: 1.2rem;
    border-radius: 8px;
    border: 2px solid #666; /* Viền tối hơn */
    background: #333; /* Nền input tối hơn */
    color: #eee; /* Chữ input sáng hơn */
    box-sizing: border-box;
    margin-bottom: 15px;
    transition: border-color 0.3s, box-shadow 0.3s;
  }
  #answer-input-new:focus {
    border-color: #00bfff; /* Viền focus sáng hơn */
    box-shadow: 0 0 8px rgba(0, 191, 255, 0.6);
    outline: none;
  }
  #result-message-new {
    font-weight: bold;
    text-align: center;
    min-height: 30px;
    font-size: 1.2rem;
    margin-bottom: 10px;
    color: #f0f0f0; /* Chữ sáng hơn */
  }
  #btn-surrender {
    margin-top: 20px;
    background: #cc0000; /* Màu đỏ đậm hơn */
    border-color: #990000;
    color: white;
    padding: 12px 25px;
    font-size: 1.1rem;
  }
  #btn-surrender:hover {
    background: #990000;
  }

  /* Flash animations (reused) */
  .flash-correct {
    animation: flashCorrect 0.5s ease-in-out 3;
  }
  .flash-wrong {
    animation: flashWrong 0.5s ease-in-out 3;
  }
  @keyframes flashCorrect {
    0%, 100% { background-color: transparent; }
    50% { background-color: rgba(0, 255, 0, 0.3); } /* Xanh lá sáng hơn */
  }
  @keyframes flashWrong {
    0%, 100% { background-color: transparent; }
    50% { background-color: rgba(255, 0, 0, 0.3); } /* Đỏ sáng hơn */
  }

  /* Screen flash animations */
  .screen-flash-green {
    animation: screenFlashGreen 0.3s ease-out;
  }
  .screen-flash-red {
    animation: screenFlashRed 0.3s ease-out;
  }

  @keyframes screenFlashGreen {
    0% { background-color: rgba(0, 255, 0, 0.2); }
    100% { background-color: transparent; }
  }
  @keyframes screenFlashRed {
    0% { background-color: rgba(255, 0, 0, 0.2); }
    100% { background-color: transparent; }
  }

  /* Battle Stage Styles */
  #battle-stage {
    width: 100%;
    max-width: 900px;
    height: 200px;
    margin-top: 0;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    position: relative;
    overflow: hidden;
    /* Nền battle stage huyền bí hơn */
    background: url('img/space_battle_background.png') no-repeat center center; /* Thay ảnh nền */
    background-size: cover;
    border-radius: 15px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.5);
  }

  .battle-character-container {
    position: absolute;
    bottom: 0;
    width: 150px;
    height: 180px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
  }

  #player-char-container {
    left: 20px;
  }

  #opponent-char-container {
    right: 20px;
  }

  .battle-character {
    width: 100%;
    height: 150px;
    object-fit: contain;
    transition: transform 0.1s ease-out;
  }

  #player-battle-char {
    transform: scaleX(1);
  }

  #opponent-battle-char {
    transform: scaleX(-1);
  }

  /* Health bar on top of character */
  .character-health-bar-container {
    width: 80%;
    background: rgba(0,0,0,0.7); /* Nền thanh máu tối hơn */
    border-radius: 5px;
    height: 10px;
    margin-bottom: 5px;
    overflow: hidden;
    position: relative;
  }
  .character-health-bar {
    height: 100%;
    background: #00ff00; /* Màu xanh lá sáng hơn */
    width: 100%;
    transition: width 0.3s ease;
  }
  .character-health-text {
    position: absolute;
    top: -15px;
    width: 100%;
    text-align: center;
    color: white;
    font-size: 0.8em;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.9);
  }

  /* Attack Animations */
  @keyframes playerAttack {
    0% { transform: translateX(0) scaleX(1); }
    50% { transform: translateX(50px) scaleX(1.1); }
    100% { transform: translateX(0) scaleX(1); }
  }

  @keyframes opponentAttack {
    0% { transform: translateX(0) scaleX(-1); }
    50% { transform: translateX(-50px) scaleX(-1.1); }
    100% { transform: translateX(0) scaleX(-1); }
  }

  /* Hit/Damage Animation (on the character being hit) */
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-5px); }
    40%, 80% { transform: translateX(5px); }
  }

  .player-attack-anim {
    animation: playerAttack 0.3s ease-out;
  }

  .opponent-attack-anim {
    animation: opponentAttack 0.3s ease-out;
  }

  .player-hit-anim {
    animation: shake 0.2s ease-out 2;
  }

  .opponent-hit-anim {
    animation: shake 0.2s ease-out 2;
  }

  /* Skill effect animations */
  .skill-effect {
    position: absolute;
    width: 50px;
    height: 50px;
    background-size: contain;
    background-repeat: no-repeat;
    z-index: 10;
  }

  /* Player Attack Effects */
  @keyframes swordAttack {
    0% { transform: translateX(0) rotate(0deg); opacity: 0; }
    20% { opacity: 1; }
    70% { transform: translateX(200px) rotate(360deg); }
    100% { transform: translateX(400px) rotate(720deg); opacity: 0; }
  }

  @keyframes magicAttack {
    0% { transform: scale(0.5) translateX(0); opacity: 0; }
    30% { opacity: 1; transform: scale(1.2); } 
    70% { transform: translateX(150px) scale(1.5); }
    100% { transform: translateX(300px) scale(0.5); opacity: 0; }
  }

  @keyframes arrowAttack {
    0% { transform: translateX(0) translateY(0); opacity: 0; }
    20% { opacity: 1; }
    70% { transform: translateX(250px) translateY(-50px); }
    100% { transform: translateX(500px) translateY(0); opacity: 0; }
  }

  /* Opponent Attack Effects (mới) */
  @keyframes fireballAttack {
    0% { transform: translateX(0) scale(0.5); opacity: 0; }
    30% { opacity: 1; transform: scale(1.2); }
    70% { transform: translateX(-150px) scale(1.5); } /* Di chuyển ngược lại */
    100% { transform: translateX(-300px) scale(0.5); opacity: 0; }
  }

  @keyframes poisonAttack {
    0% { transform: translateX(0) translateY(0); opacity: 0; }
    20% { opacity: 1; }
    70% { transform: translateX(-250px) translateY(-50px); } /* Di chuyển ngược lại */
    100% { transform: translateX(-500px) translateY(0); opacity: 0; }
  }

  @keyframes darkEnergyAttack {
    0% { transform: scale(0.1); opacity: 0; }
    50% { transform: scale(1.5); opacity: 1; }
    100% { transform: scale(0.1); opacity: 0; }
  }


  .hit-effect {
    position: absolute;
    width: 80px;
    height: 80px;
    background-image: radial-gradient(circle, rgba(255,0,0,0.8) 0%, transparent 70%);
    border-radius: 50%;
    animation: hitFlash 0.3s ease-out;
    z-index: 10;
  }

  @keyframes hitFlash {
    0% { transform: scale(0.3); opacity: 0; }
    50% { transform: scale(1); opacity: 0.8; }
    100% { transform: scale(0.5); opacity: 0; }
  }

  @keyframes hitFlash {
    0% { opacity: 1; }
    50% { opacity: 0.3; }
    100% { opacity: 1; }
  }


  /* Responsive adjustments */
  @media (max-width: 768px) {
    #game-arena {
      flex-direction: column;
      align-items: center;
    }
    #answer-input-new {
      width: 95%;
    }
    #battle-stage {
      height: 150px;
    }
    .battle-character-container {
      width: 100px;
      height: 130px;
    }
    .battle-character {
      height: 100px;
    }
    #player-char-container { left: 10px; }
    #opponent-char-container { right: 10px; }

    .character, .opponent {
        width: 120px;
        height: 180px;
    }
    .character img, .opponent img {
        height: 120px;
    }
    .character-carousel, .opponent-carousel {
        gap: 15px;
    }
    #topic-selection .centered {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }
    #topic-selection button {
        font-size: 1rem;
        padding: 12px 8px;
    }
  }
</style>
</head>
<body>

<h1>Chọn Nhân Vật</h1>
<div id="character-selection">
  <div class="character-carousel">
    <div class="character" data-character="Swordsman">
      <img src="img/Kiemsi.png" alt="Kiếm sĩ" />
      <div>Kiếm sĩ</div>
    </div>
    <div class="character" data-character="Mage">
      <img src="img/Phapsu.png" alt="Pháp sư" />
      <div>Pháp sư</div>
    </div>
    <div class="character" data-character="SpiritBeast">
      <img src="img/rong.png" alt="Rồng" />
      <div>Rồng</div>
    </div>
    <div class="character" data-character="Archer">
      <img src="img/Cungthu.png" alt="Cung thủ" />
      <div>Cung thủ</div>
    </div>
  </div>

  <div id="skill-info-display">
    <h3 id="skill-name"></h3>
    <p id="skill-description"></p>
  </div>

  <!-- Nút "Tiếp tục" sẽ được thêm bằng JS -->
</div>

<!-- New Opponent Selection Area -->
<div id="opponent-selection" style="display: none;">
  <h1>Chọn Đối Thủ</h1>
  <div class="opponent-carousel">
    <div class="opponent" data-opponent="Slime">
      <img src="img/quai1.png" alt="Slime" />
      <div>Slime (Dễ)</div>
    </div>
    <div class="opponent" data-opponent="Goblin">
      <img src="img/quai2.png" alt="Goblin" />
      <div>Goblin (Trung bình)</div>
    </div>
    <div class="opponent" data-opponent="Orc">
      <img src="img/quai3.png" alt="Orc" />
      <div>Orc (Khó)</div>
    </div>
    <div class="opponent" data-opponent="Dragon">
      <img src="img/quai4.png" alt="Dragon" />
      <div>Dragon (Rất khó)</div>
    </div>
  </div>

  <div id="opponent-skill-info-display">
    <h3 id="opponent-skill-name"></h3>
    <p id="opponent-skill-description"></p>
  </div>

  <!-- Nút "Tiếp tục" cho đối thủ sẽ được thêm bằng JS -->
</div>


<div id="topic-selection" style="display: none;">
  <h2>Chọn Chủ Đề</h2>
  <div class="centered">
    	<button onclick="startQuiz('jobs')">Nghề nghiệp</button>
    	<button onclick="startQuiz('verbs')">Động từ</button>
    	<button onclick="startQuiz('collocations')">Collocations</button>
	    <button onclick="startQuiz('tinhtumota')">Tính từ mô tả</button>
	    <button onclick="startQuiz('tinhtucamxuc')">Tính từ cảm xúc</button>
	    <button onclick="startQuiz('dovatquenthuoc')">Đồ vật quen thuộc</button>
	    <button onclick="startQuiz('diadiem')">Địa điểm</button>
	    <button onclick="startQuiz('ptgt')">Phương tiện GT</button>
	    <button onclick="startQuiz('v2')">v2</button>
	    <button onclick="startQuiz('v3')">v3</button>
		<button onclick="startQuiz('moitruong')">Môi trường</button>
		<button onclick="startQuiz('communication')">communication</button>
		<button onclick="startQuiz('advertising')">advertising</button>
  </div>
</div>

<!-- New Game Arena -->
<div id="game-arena">
  <!-- Battle Stage -->
  <div id="battle-stage">
    <div id="player-char-container" class="battle-character-container">
      <div class="character-health-bar-container">
        <div id="player-health-bar" class="character-health-bar"></div>
        <div id="player-health-text" class="character-health-text"></div>
      </div>
      <img id="player-battle-char" class="battle-character" src="" alt="Player Battle Character">
    </div>
    
    <div id="opponent-char-container" class="battle-character-container">
      <div class="character-health-bar-container">
        <div id="opponent-health-bar" class="character-health-bar"></div>
        <div id="opponent-health-text" class="character-health-text"></div>
      </div>
      <!-- Hình ảnh quái vật sẽ được cập nhật bằng JS -->
      <img id="opponent-battle-char" class="battle-character" src="" alt="Opponent Battle Character">
    </div>
  </div>

  <div id="question-area">
    <div id="current-turn"></div>
    <div id="quiz-question-new"></div>
    <input type="text" id="answer-input-new" placeholder="Nhập câu trả lời tiếng Anh" onkeydown="handleKeyNew(event)" autocomplete="off" />
    <div id="result-message-new"></div>
    <button id="btn-surrender" onclick="surrenderGame()">Đầu hàng!</button>
  </div>
</div>

<script>
   const data = {
      "jobs": [
        { img: "img/thu ngân.png", en: "cashier", vi: "thu ngân" },
        { img: "img/đầu bếp.png", en: "chef", vi: "đầu bếp" },
        { img: "img/giám đốc.png", en: "director", vi: "giám đốc" },
        { img: "img/đạo diễn.png", en: "director", vi: "đạo diễn" },
        { img: "img/bác sĩ.png", en: "doctor", vi: "bác sĩ" },
        { img: "img/tiến sĩ.png", en: "doctor", vi: "tiến sĩ" },
        { img: "img/nhân viên.png", en: "employee,staff,worker", vi: "nhân viên" },
        { img: "img/thực tập sinh.png", en: "intern, trainee", vi: "thực tập sinh" },
        { img: "img/nhân viên phục vụ.png", en: "server, waiter, attendant", vi: "nhân viên phục vụ" },
        { img: "img/phục vụ nữ.png", en: "waitress", vi: "phục vụ nữ" },
        { img: "img/người trình diễn.png", en: "performer", vi: "người trình diễn" },
        { img: "img/kĩ thuật viên.png", en: "technician", vi: "kĩ thuật viên" },
        { img: "img/giáo viên.png", en: "teacher", vi: "giáo viên" },
        { img: "img/giảng viên.png", en: "lecturer", vi: "giảng viên" },
        { img: "img/giáo sư.png", en: "professor", vi: "giáo sư" },
        { img: "img/gia sư.png", en: "tutor", vi: "gia sư" },
      ],
      "verbs": [
        { img: "img/book.jpeg", en: "book,reserve", vi: "đặt trước" },
        { img: "img/cất cánh.jpeg", en: "leave,take off", vi: "cất cánh" },
        { img: "img/di chuyển.jpeg", en: "travel,move,commute", vi: "di chuyển" },
        { img: "img/exercise.jpeg", en: "exercise,work out", vi: "tập thể dục" },
        { img: "", en: "run,operate", vi: "chạy" },
        { img: "", en: "stalk,communicate", vi: "nói" },
        { img: "img/wear.jpeg", en: "wear,put on", vi: "mặc,đeo" },
        { img: "img/rời đi.jpeg", en: "leave,take off", vi: "rời đi" },
        { img: "", en: "sorry,apologize for", vi: "xin lỗi" },
        { img: "", en: "buy,purchase,acquire", vi: "mua" },
        { img: "", en: "help,assist,support", vi: "giúp" },
      ],

      "collocations": [
        { en: "come", vi: "Đi tới" },
        { en: "come up with", vi: "Nghĩ ra, sáng tạo ra" },
        { en: "come across", vi: "Tình cờ gặp" },
        { en: "come to an end", vi: "Kết thúc" },
        { en: "do", vi: "Làm" },
        { en: "do a favor", vi: "Làm ơn" },
        { en: "do the laundry", vi: "Giặt đồ" },
        { en: "do business", vi: "Làm ăn, kinh doanh" },
        { en: "get", vi: "Lấy" },
        { en: "get a job", vi: "Tìm được việc" },
        { en: "get along with", vi: "Hòa hợp với ai đó" },
        { en: "get rid of", vi: "Loại bỏ" },
        { en: "give", vi: "Đưa, tặng" },
        { en: "give a presentation", vi: "Thuyết trình" },
        { en: "give a speech", vi: "Phát biểu" },
        { en: "give a call", vi: "Gọi điện" },
        { en: "have", vi: "Có, sở hữu" },
        { en: "have a break", vi: "Nghỉ giải lao" },
        { en: "have a lunch/dinner", vi: "Ăn trưa, ăn tối" },
        { en: "have a look", vi: "Nhìn, xem" },
        { en: "look", vi: "Nhìn" },
        { en: "look forward to", vi: "Mong đợi, háo hức làm gì" },
        { en: "look after", vi: "Chăm sóc" },
        { en: "look over", vi: "Kiểm tra, xem qua" },
        { en: "make", vi: "Làm" },
        { en: "make a decision", vi: "Ra quyết định" },
        { en: "make a reservation", vi: "Đặt phòng" },
        { en: "make an appointment", vi: "Đặt lịch hẹn" },
        { en: "reach", vi: "Với lấy, chạm tới, đi tới" },
        { en: "reach a conclusion", vi: "Đi đến kết luận" },
        { en: "reach a goal", vi: "Đạt được mục tiêu" },
        { en: "reach out", vi: "Liên lạc, tiếp cận" },
        { en: "set", vi: "Đặt, để" },
        { en: "set a goal", vi: "Đặt mục tiêu" },
        { en: "set an example", vi: "Làm gương" },
        { en: "set the rules", vi: "Đặt ra quy định" },
        { en: "take", vi: "Lấy" },
        { en: "take part in", vi: "Tham gia vào" },
        { en: "take advantage of", vi: "Tận dụng" },
        { en: "take care of", vi: "Chăm sóc, xử lí" },
      ],
"tinhtumota":[
    { en: "beautiful", vi: "xinh đẹp" },
    { en: "stunning", vi: "đẹp choáng ngộp" },
    { en: "good-looking", vi: "ưa nhìn" },
    { en: "pretty", vi: "xinh đẹp (nói về nữ)" },
    { en: "attractive", vi: "thu hút" },
    { en: "cheap", vi: "rẻ,giá thấp" },
    { en: "affordable,economical", vi: "rẻ" },
    { en: "low-cost", vi: "giá thấp" },
    { en: "effective,efficient,productive", vi: "hiệu quả" },
    { en: "expensive,costly,overpriced", vi: "đắt tiền" },
    { en: "loyal", vi: "chung thành" },
    { en: "modern,state-of-the-art,innovative,advanced", vi: "hiện đại" },
    { en: "narrow,restricted,compact", vi: "hẹp,chật hẹp" },
    { en: "thin,slim,fit,skinny,trim", vi: "ốm,mỏng" },
    { en: "useful,beneficial", vi: "hữu ích" },
    { en: "helpful", vi: "có ích" },
    { en: "profitable", vi: "có lợi" },
    { en: "wide,spacious,expansive", vi: "rộng" },
	],
"tinhtucamxuc":[
    { en: "angry,furious", vi: "tức giận" },
    { en: "bored,uninterested", vi: "chán nản" },
    { en: "confident", vi: "tự tin" },
    { en: "grateful,thankful", vi: "biết ơn" },
    { en: "happy,joyful,pleased,delighted", vi: "hạnh phúc" },
    { en: "nervous,anxious", vi: "lo lắng" },
    { en: "proud,thankful", vi: "tự hào" },
    { en: "sad,unsatisfied", vi: "buồn" },
    { en: "satisfied,fulfilled", vi: "thỏa mản" },
    { en: "surprised,astonished,shocked", vi: "ngạc nhiên" },
	],
"dovatquenthuoc":[
	 { en: "ceiling", vi: "Trần nhà" },
	 { en: "chair,stool", vi: "ghế" },
	  { en: "counter", vi: "cái quầy" },
	   { en: "cupboard,cabinet,drawer", vi: "cái tủ" },
	   { en: "fence", vi: "hàng rào" },
	    { en: "gate", vi: "cổng" },
		 { en: "pot,vase", vi: "cái nồi,cái chậu" },
		  { en: "railing", vi: "rào chắn,lan can" },
		   { en: "sink", vi: "cái bồn" },
		    { en: "sofa,armchair,couch,bench", vi: "ghế đệm" },
	],
"diadiem":[
	 { en: "boardroom,meeting room", vi: "Phòng họp" },
	 { en: "factory,plant", vi: "Nhà máy" },
	 { en: "gallery", vi: "phòng trưng bày" },
	 { en: "lobby,hall", vi: "Sảnh" },
	 { en: "mall,shopping center,department store", vi: "Trung tâm thương mại" },
	 { en: "museum", vi: "Bảo tàng" },
	 { en: "Station", vi: "Bến xe, nhà ga" },
	 { en: "Theater", vi: "rạp kịch" },
	 { en: "university,college", vi: "Đại học" },
	 { en: "warehouse", vi: "Nhà kho" },
 ],
"ptgt":[
	{ en: "entrance", vi: "lối vào" },
	{ en: "intersection,crossroad", vi: "Giao lộ, ngã 4" },
	{ en: "lane", vi: "Làn đường" },
	{ en: "one-way street", vi: "Đường 1 chiều" },
	{ en: "parking lot", vi: "Bãi đỗ xe" },
	{ en: "passenger,commuter,traveler", vi: "Hành khách" },
	{ en: "pavement,sidewalk", vi: "lề đường" },
	{ en: "roadwork,construction", vi: "thi công trên đường" },
	{ en: "sign", vi: "Biển báo" },
	{ en: "Traffic lights", vi: "Đèn giao thông" },
	{ en: "vehicle", vi: "Phương tiện" },
 ],
"v2":[
    { "en": "arose", "vi": "arise (phát sinh)" },
    { "en": "awoke", "vi": "awake (thức dậy)" },
    { "en": "was/were", "vi": "be (thì, là)" },
    { "en": "bore", "vi": "bear (sinh ra)" },
    { "en": "beat", "vi": "beat (đánh)" },
    { "en": "became", "vi": "become (trở thành)" },
    { "en": "began", "vi": "begin (bắt đầu)" },
    { "en": "bent", "vi": "bend (bẻ cong)" },
    { "en": "bet", "vi": "bet (cá cược)" },
    { "en": "bit", "vi": "bite (cắn)" },
    { "en": "bled", "vi": "bleed (chảy máu)" },
    { "en": "blew", "vi": "blow (thổi)" },
    { "en": "broke", "vi": "break (làm vỡ)" },
    { "en": "brought", "vi": "bring (mang đến)" },
    { "en": "broadcast", "vi": "broadcast (phát sóng)" },
    { "en": "built", "vi": "build (xây dựng)" },
    { "en": "burnt/burned", "vi": "burn (đốt cháy)" },
    { "en": "burst", "vi": "burst (nổ tung)" },
    { "en": "bought", "vi": "buy (mua)" },
    { "en": "caught", "vi": "catch (bắt)" },
    { "en": "chose", "vi": "choose (chọn)" },
    { "en": "came", "vi": "come (đến)" },
    { "en": "cost", "vi": "cost (tốn)" },
    { "en": "cut", "vi": "cut (cắt)" },
    { "en": "dealt", "vi": "deal (giải quyết)" },
    { "en": "dug", "vi": "dig (đào)" },
    { "en": "did", "vi": "do (làm)" },
    { "en": "drew", "vi": "draw (vẽ)" },
    { "en": "dreamt/dreamed", "vi": "dream (mơ)" },
    { "en": "drank", "vi": "drink (uống)" },
    { "en": "drove", "vi": "drive (lái xe)" },
    { "en": "ate", "vi": "eat (ăn)" },
    { "en": "fell", "vi": "fall (ngã)" },
    { "en": "fed", "vi": "feed (cho ăn)" },
    { "en": "felt", "vi": "feel (cảm thấy)" },
    { "en": "fought", "vi": "fight (chiến đấu)" },
    { "en": "found", "vi": "find (tìm thấy)" },
    { "en": "flew", "vi": "fly (bay)" },
    { "en": "forbade", "vi": "forbid (cấm)" },
    { "en": "forgot", "vi": "forget (quên)" },
    { "en": "forgave", "vi": "forgive (tha thứ)" },
    { "en": "froze", "vi": "freeze (đóng băng)" },
    { "en": "got", "vi": "get (có được)" },
    { "vi": "give (cho)", "en": "given" },
    { "vi": "go (đi)", "en": "gone" },
    { "vi": "grow (phát triển)", "en": "grown" },
    { "vi": "hang (treo)", "en": "hung" },
    { "vi": "have (có)", "en": "had" },
    { "vi": "hear (nghe)", "en": "heard" },
    { "vi": "hid", "vi": "hide (ẩn, giấu)" },
    { "vi": "hit (đánh)", "en": "hit" },
    { "vi": "hold (giữ)", "en": "held" },
    { "vi": "hurt (làm đau)", "en": "hurt" },
    { "vi": "keep (giữ)", "en": "kept" },
    { "vi": "know (biết)", "en": "known" },
    { "vi": "lay (đặt, để)", "en": "laid" },
    { "vi": "lead (dẫn dắt)", "en": "led" },
    { "vi": "leave (rời đi)", "en": "left" },
    { "vi": "lend (cho mượn)", "en": "lent" },
    { "vi": "let (để cho)", "en": "let" },
    { "vi": "lay (nằm)", "en": "lain" },
    { "vi": "light (thắp sáng)", "en": "lit,lighted" },
    { "vi": "lose (mất)", "en": "lost" },
    { "vi": "make (làm)", "en": "made" },
    { "vi": "mean (có nghĩa)", "en": "meant" },
    { "vi": "meet (gặp)", "en": "met" },
    { "vi": "pay (trả)", "en": "paid" },
    { "vi": "put (đặt)", "en": "put" },
    { "vi": "read (đọc)", "en": "read" },
    { "vi": "ride (cưỡi)", "en": "ridden" },
    { "vi": "ring (rung chuông)", "en": "rung" },
    { "vi": "rise (mọc lên)", "en": "risen" },
    { "vi": "run (chạy)", "en": "run" },
    { "vi": "say (nói)", "en": "said" },
    { "vi": "see (nhìn thấy)", "en": "seen" },
    { "vi": "seek (tìm kiếm)", "en": "sought" },
    { "vi": "sell (bán)", "en": "sold" },
    { "vi": "send (gửi)", "en": "sent" },
    { "vi": "set (đặt)", "en": "set" }
],
"v3":[
    { "vi": "arise (phát sinh)", "en": "arisen" },
    { "vi": "awake (thức dậy)", "en": "awoken" },
    { "vi": "be (thì, là)", "en": "been" },
    { "vi": "bear (sinh ra)", "en": "born" },
    { "vi": "beat (đánh)", "en": "beaten" },
    { "vi": "become (trở thành)", "en": "become" },
    { "vi": "begin (bắt đầu)", "en": "begun" },
    { "vi": "bend (bẻ cong)", "en": "bent" },
    { "vi": "bet (cá cược)", "en": "bet" },
    { "vi": "bite (cắn)", "en": "bitten" },
    { "vi": "bleed (chảy máu)", "en": "bled" },
    { "vi": "blow (thổi)", "en": "blown" },
    { "vi": "break (làm vỡ)", "en": "broken" },
    { "vi": "bring (mang đến)", "en": "brought" },
    { "vi": "broadcast (phát sóng)", "en": "broadcast" },
    { "vi": "build (xây dựng)", "en": "built" },
    { "vi": "burn (đốt cháy)", "en": "burnt/burned" },
    { "vi": "burst (nổ tung)", "en": "burst" },
    { "vi": "buy (mua)", "en": "bought" },
    { "vi": "catch (bắt)", "en": "caught" },
    { "vi": "choose (chọn)", "en": "chosen" },
    { "vi": "come (đến)", "en": "come" },
    { "vi": "cost (tốn)", "en": "cost" },
    { "vi": "cut (cắt)", "en": "cut" },
    { "vi": "deal (giải quyết)", "en": "dealt" },
    { "vi": "dig (đào)", "en": "dug" },
    { "vi": "do (làm)", "en": "done" },
    { "vi": "draw (vẽ)", "en": "drawn" },
    { "vi": "dream (mơ)", "en": "dreamt/dreamed" },
    { "vi": "drink (uống)", "en": "drunk" },
    { "vi": "drive (lái xe)", "en": "driven" },
    { "vi": "eat (ăn)", "en": "eaten" },
    { "vi": "fall (ngã)", "en": "fallen" },
    { "vi": "feed (cho ăn)", "en": "fed" },
    { "vi": "feel (cảm thấy)", "en": "felt" },
    { "vi": "fight (chiến đấu)", "en": "fought" },
    { "vi": "find (tìm thấy)", "en": "found" },
    { "vi": "fly (bay)", "en": "flown" },
    { "vi": "forbid (cấm)", "en": "forbidden" },
    { "vi": "forget (quên)", "en": "forgotten" },
    { "vi": "forgive (tha thứ)", "en": "forgiven" },
    { "vi": "freeze (đóng băng)", "en": "frozen" },
    { "vi": "get (có được)", "en": "got/gotten" },
    { "vi": "give (cho)", "en": "given" },
    { "vi": "go (đi)", "en": "gone" },
    { "vi": "grow (phát triển)", "en": "grown" },
    { "vi": "hang (treo)", "en": "hung" },
    { "vi": "have (có)", "en": "had" },
    { "vi": "hear (nghe)", "en": "heard" },
    { "vi": "hid", "vi": "hide (ẩn, giấu)" },
    { "vi": "hit (đánh)", "en": "hit" },
    { "vi": "hold (giữ)", "en": "held" },
    { "vi": "hurt (làm đau)", "en": "hurt" },
    { "vi": "keep (giữ)", "en": "kept" },
    { "vi": "know (biết)", "en": "known" },
    { "vi": "lay (đặt, để)", "en": "laid" },
    { "vi": "lead (dẫn dắt)", "en": "led" },
    { "vi": "leave (rời đi)", "en": "left" },
    { "vi": "lend (cho mượn)", "en": "lent" },
    { "vi": "let (để cho)", "en": "let" },
    { "vi": "lay (nằm)", "en": "lain" },
    { "vi": "light (thắp sáng)", "en": "lit,lighted" },
    { "vi": "lose (mất)", "en": "lost" },
    { "vi": "make (làm)", "en": "made" },
    { "vi": "mean (có nghĩa)", "en": "meant" },
    { "vi": "met", "vi": "meet (gặp)" },
    { "vi": "pay (trả)", "en": "paid" },
    { "vi": "put (đặt)", "en": "put" },
    { "vi": "read (đọc)", "en": "read" },
    { "vi": "ride (cưỡi)", "en": "ridden" },
    { "vi": "ring (rung chuông)", "en": "rung" },
    { "vi": "rise (mọc lên)", "en": "risen" },
    { "vi": "run (chạy)", "en": "run" },
    { "vi": "say (nói)", "en": "said" },
    { "vi": "see (nhìn thấy)", "en": "seen" },
    { "vi": "seek (tìm kiếm)", "en": "sought" },
    { "vi": "sell (bán)", "en": "sold" },
    { "vi": "send (gửi)", "en": "sent" },
    { "vi": "set (đặt)", "en": "set" }
],
"moitruong":[
	{ "vi": "Sự bảo tồn", "en": "conservation" },
	{ "vi": "Thân thiện với môi trường", "en": "eco-friendly, environmentally friendly" },
	{ "vi": "Hệ sinh thái", "en": "ecosystem" },
	{ "vi": "Khí thải", "en": "emission, release" },
	{ "vi": "Môi trường sống", "en": "habitat,environment" },
	{ "vi": "Sự ô nhiễm", "en": "pollution" },
	{ "vi": "Tái chế", "en": "recycle,repurpose" },
	{ "vi": "Giảm", "en": "reduce,decrease" },
	{ "vi": "Tăng", "en": "increase" },
	{ "vi": "tái sử dụng", "en": "reuse" },
	{ "vi": "Loài", "en": "species" },
],
"communication":[
    { en: "Announcement,Notice,Statement", vi: "Sự thông báo" },
    { en: "clarify,Explain", vi: "Làm rõ,Giải thích" },
    { en: "collaborate,cooperate ", vi: "Hợp tác" },
    { en: "Communicate,Convey,Share", vi: "Truyền đạt,Thông báo,Chia sẻ" },
    { en: "Conference,Convention,Seminar", vi: " Hội nghị,Hội thảo" },
    { en: "Exchange", vi: "Trao đổi" },
    { en: "Inquiry,Question, Request", vi: "Câu hỏi" },
    { en: "Message,Note", vi: "thư tín" },
    { en: "Negotiation", vi: "Đàm phán, thương lượng" },
    { en: "Reminder,alert", vi: "Lời nhắc nhở" },
      ],
  "advertising":[
    { en: "advertise,promote,publicize", vi: "Quảng cáo, quảng bá" },
    { en: "billboard,hoarding,poster", vi: "Biển quảng cáo, áp phít" },
    { en: "brand,label,trademark", vi: "thương hiệu, nhãn dán, thương hiệu đã đăng kí bản quyền"},
    { en: "brochure,flyer,pamphlet,leaflet", vi: "Tờ quảng cáo" },
    { en: "Campaign, advertising campaign", vi: "Chiến dịch, chiến dịch quảng cáo" },
    { en: "endorsement,approval,recommendation", vi: "Sự chứng nhận" },
    { en: "Promotion,sale,discount", vi: "Sự khuyến mãi" },
    { en: "Slogan,motto", vi: "Khẩu hiệu" },
    { en: "Sponsor", vi: "Tài trợ, nhà tài trợ" },
    { en: "Target audience, customer base,demographic", vi: "Khách hàng mục tiêu" },
    ],
  };
 
  // Cấu hình máu
  const maxHealth = 200; // Máu người chơi
  let playerHealth = maxHealth;
  let opponentHealth = 0; // Máu đối thủ sẽ được thiết lập khi chọn đối thủ
	
  // Các biến trạng thái
  let currentCharacter = null; // Nhân vật người chơi đã chọn
  let playerCharacter = null; // Tên nhân vật người chơi trong trận đấu
  let selectedOpponentType = null; // Loại đối thủ người chơi đã chọn (e.g., "Slime", "Goblin")
  let currentOpponent = null; // Đối tượng quái vật hiện tại (bao gồm cả skill, accuracy)

  let currentTopic = null;
  let currentQuestionIndex = 0;
  let currentQuizList = [];

  let currentPlayerTurn = 'player'; // 'player' hoặc 'opponent'
  let gameEnded = false; // Biến cờ để tránh gọi resetGame nhiều lần

  let consecutiveCorrectAnswers = 0; // Số câu trả lời đúng liên tiếp
  const CONSECUTIVE_BONUS_THRESHOLD = 3; // Ngưỡng để nhận thưởng đúng liên tiếp

  // Biến mới để theo dõi lượt trả lời của mỗi câu hỏi
  let playerAnswered = false;
  let opponentAnswered = false;

  // DOM elements
  const bodyEl = document.body;
  const characterSelectionEl = document.getElementById('character-selection');
  const opponentSelectionEl = document.getElementById('opponent-selection'); // New
  const topicSelectionEl = document.getElementById('topic-selection');
  const gameArenaEl = document.getElementById('game-arena');

  const currentTurnEl = document.getElementById('current-turn');
  const quizQuestionNewEl = document.getElementById('quiz-question-new');
  const answerInputNewEl = document.getElementById('answer-input-new');
  const resultMessageNewEl = document.getElementById('result-message-new');

  const playerBattleCharEl = document.getElementById('player-battle-char');
  const opponentBattleCharEl = document.getElementById('opponent-battle-char');
  const playerHealthBarEl = document.getElementById('player-health-bar');
  const opponentHealthBarEl = document.getElementById('opponent-health-bar');
  const playerHealthTextEl = document.getElementById('player-health-text');
  const opponentHealthTextEl = document.getElementById('opponent-health-text');

  const skillInfoDisplayEl = document.getElementById('skill-info-display');
  const skillNameEl = document.getElementById('skill-name');
  const skillDescriptionEl = document.getElementById('skill-description');

  const opponentSkillInfoDisplayEl = document.getElementById('opponent-skill-info-display'); // New
  const opponentSkillNameEl = document.getElementById('opponent-skill-name'); // New
  const opponentSkillDescriptionEl = document.getElementById('opponent-skill-description'); // New


  // Các nhân vật - hình ảnh
  const characterImages = {
    "Swordsman": "img/Kiemsi.png",
    "Mage": "img/Phapsu.png",
    "SpiritBeast": "img/rong.png",
    "Archer": "img/Cungthu.png"
  };

  // Thông tin khả năng của từng nhân vật
  const characterSkills = {
    "Swordsman": {
      name: "Kiếm sĩ (Tấn công mạnh)",
      description: "Khi trả lời đúng, gây thêm 5 sát thương.",
      onCorrect: (damage) => damage + 5
    },
    "Mage": {
      name: "Pháp sư (Hồi phục)",
      description: "Khi trả lời đúng, hồi 10 máu cho bản thân.",
      onCorrect: () => healPlayer(10)
    },
    "SpiritBeast": {
      name: "Rồng (Phòng thủ)",
      description: "Giảm 50% sát thương nhận vào từ đối thủ.",
      onDamageTaken: (damage) => damage * 0.5
    },
    "Archer": {
      name: "Cung thủ (Tấn công liên hoàn)",
      description: "Khi trả lời đúng, có 70% cơ hội tấn công thêm 1 lần nữa.",
      onCorrect: (damage) => {
        if (Math.random() < 0.7) { // 70% chance
          damageOpponent(damage);
          resultMessageNewEl.textContent += " Cung thủ tấn công thêm một lần!";
        }
      }
    }
  };

  // Danh sách các đối thủ với kỹ năng và độ khó riêng
  const opponentsData = {
    "Slime": {
      name: "Slime",
      img: "img/quai1.png",
      maxHealth: 100,
      baseDamage: 10,
      aiAccuracy: 0.6, // 60% đúng
      skill: {
        name: "Phản đòn yếu",
        description: "Khi trả lời sai, có 20% cơ hội gây thêm 5 sát thương.",
        onWrongAnswer: () => {
          if (Math.random() < 0.2) {
            damagePlayer(5);
            resultMessageNewEl.textContent += " Slime phản đòn yếu!";
          }
        },
        effectImg: "img/slime_attack.png", // Ảnh hiệu ứng tấn công của Slime
        effectAnim: "fireballAttack" // Animation cho hiệu ứng
      }
    },
    "Goblin": {
      name: "Goblin",
      img: "img/quai2.png",
      maxHealth: 150,
      baseDamage: 15,
      aiAccuracy: 0.7, // 70% đúng
      skill: {
        name: "Tấn công nhanh",
        description: "Khi trả lời đúng, có 15% cơ hội tấn công 2 lần.",
        onCorrectAnswer: () => {
          if (Math.random() < 0.15) {
            damagePlayer(currentOpponent.baseDamage);
            resultMessageNewEl.textContent += " Goblin tấn công nhanh!";
          }
        },
        effectImg: "img/goblin_attack.png", // Ảnh hiệu ứng tấn công của Goblin
        effectAnim: "poisonAttack" // Animation cho hiệu ứng
      }
    },
    "Orc": {
      name: "Orc",
      img: "img/quai3.png",
      maxHealth: 200,
      baseDamage: 20,
      aiAccuracy: 0.8, // 80% đúng
      skill: {
        name: "Giáp gai",
        description: "Khi bị tấn công, có 25% cơ hội phản lại 10 sát thương.",
        onDamageTaken: () => {
          if (Math.random() < 0.25) {
            damagePlayer(10);
            resultMessageNewEl.textContent += " Orc phản lại sát thương!";
          }
        },
        effectImg: "img/orc_attack.png", // Ảnh hiệu ứng tấn công của Orc
        effectAnim: "darkEnergyAttack" // Animation cho hiệu ứng
      }
    },
    "Dragon": {
      name: "Dragon",
      img: "img/quai4.png",
      maxHealth: 300,
      baseDamage: 30,
      aiAccuracy: 0.9, // 90% đúng
      skill: {
        name: "Hơi thở rồng",
        description: "Khi trả lời đúng, gây thêm 10 sát thương và có 50% cơ hội gây hiệu ứng bỏng (thêm 5 sát thương mỗi lượt trong 2 lượt).",
        onCorrectAnswer: () => {
          let bonusDamage = 10;
          damagePlayer(bonusDamage);
          resultMessageNewEl.textContent += ` Rồng phun hơi thở gây thêm ${bonusDamage} sát thương!`;
          if (Math.random() < 0.5) {
            applyBurnEffect(); // Áp dụng hiệu ứng bỏng
            resultMessageNewEl.textContent += " Bạn bị bỏng!";
          }
        },
        effectImg: "img/dragon_attack.png", // Ảnh hiệu ứng tấn công của Dragon
        effectAnim: "fireballAttack" // Animation cho hiệu ứng
      }
    }
  };

  let burnTurns = 0; // Số lượt bị bỏng

  function applyBurnEffect() {
    burnTurns = 2; // Bị bỏng trong 2 lượt
  }

  function checkBurnEffect() {
    if (burnTurns > 0) {
      damagePlayer(5); // Gây 5 sát thương mỗi lượt
      resultMessageNewEl.textContent += " Bạn đang bị bỏng (-5 máu)!";
      burnTurns--;
    }
  }


  // Chọn nhân vật
  characterSelectionEl.querySelectorAll('.character').forEach(card => {
    card.addEventListener('click', () => {
      characterSelectionEl.querySelectorAll('.character').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      currentCharacter = card.dataset.character;
      
      const skill = characterSkills[currentCharacter];
      skillNameEl.textContent = skill.name;
      skillDescriptionEl.textContent = skill.description;
      skillInfoDisplayEl.style.display = 'block';
      btnContinueChar.style.display = 'block'; // Hiện nút tiếp tục chọn nhân vật
    });

    card.addEventListener('mouseenter', () => {
        if (!currentCharacter || card.dataset.character === currentCharacter) {
            const skill = characterSkills[card.dataset.character];
            skillNameEl.textContent = skill.name;
            skillDescriptionEl.textContent = skill.description;
            skillInfoDisplayEl.style.display = 'block';
        } else if (card.dataset.character !== currentCharacter) {
            const skill = characterSkills[card.dataset.character];
            skillNameEl.textContent = skill.name;
            skillDescriptionEl.textContent = skill.description;
            skillInfoDisplayEl.style.display = 'block';
        }
    });
    card.addEventListener('mouseleave', () => {
        if (!currentCharacter) {
            skillInfoDisplayEl.style.display = 'none';
        } else if (card.dataset.character === currentCharacter) {
            // Keep info if it's the selected character
        } else {
            const skill = characterSkills[currentCharacter];
            skillNameEl.textContent = skill.name;
            skillDescriptionEl.textContent = skill.description;
            skillInfoDisplayEl.style.display = 'block';
        }
    });
  });

  // Chọn đối thủ
  opponentSelectionEl.querySelectorAll('.opponent').forEach(card => {
    card.addEventListener('click', () => {
      opponentSelectionEl.querySelectorAll('.opponent').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      selectedOpponentType = card.dataset.opponent;
      currentOpponent = opponentsData[selectedOpponentType]; // Gán đối tượng đối thủ đã chọn
      
      opponentSkillNameEl.textContent = currentOpponent.skill.name;
      opponentSkillDescriptionEl.textContent = currentOpponent.skill.description;
      opponentSkillInfoDisplayEl.style.display = 'block';
      btnContinueOpponent.style.display = 'block'; // Hiện nút tiếp tục chọn đối thủ
    });

    card.addEventListener('mouseenter', () => {
        if (!selectedOpponentType || card.dataset.opponent === selectedOpponentType) {
            const skill = opponentsData[card.dataset.opponent].skill;
            opponentSkillNameEl.textContent = skill.name;
            opponentSkillDescriptionEl.textContent = skill.description;
            opponentSkillInfoDisplayEl.style.display = 'block';
        } else if (card.dataset.opponent !== selectedOpponentType) {
            const skill = opponentsData[card.dataset.opponent].skill;
            opponentSkillNameEl.textContent = skill.name;
            opponentSkillDescriptionEl.textContent = skill.description;
            opponentSkillInfoDisplayEl.style.display = 'block';
        }
    });
    card.addEventListener('mouseleave', () => {
        if (!selectedOpponentType) {
            opponentSkillInfoDisplayEl.style.display = 'none';
        } else if (card.dataset.opponent === selectedOpponentType) {
            // Keep info if it's the selected opponent
        } else {
            const skill = opponentsData[selectedOpponentType].skill;
            opponentSkillNameEl.textContent = skill.name;
            opponentSkillDescriptionEl.textContent = skill.description;
            opponentSkillInfoDisplayEl.style.display = 'block';
        }
    });
  });


  // Khi bấm nút Enter trong input trả lời
  function handleKeyNew(event) {
    if(event.key === 'Enter'){
      if (currentPlayerTurn === 'player') { // Chỉ xử lý nếu là lượt người chơi
        checkAnswerNew();
      }
    }
  }

  // Bắt đầu quiz chủ đề
  function startQuiz(topic){
    if (!currentCharacter) {
      alert('Vui lòng chọn nhân vật trước!');
      return;
    }
    if (!selectedOpponentType) {
      alert('Vui lòng chọn đối thủ trước!');
      return;
    }

    playerCharacter = currentCharacter; // Lưu nhân vật đã chọn cho trận đấu
    currentTopic = topic;
    currentQuestionIndex = 0;
    currentQuizList = data[topic].slice(); // copy mảng
    shuffleArray(currentQuizList); // Trộn danh sách câu hỏi ban đầu

    // Ẩn các phần chọn và hiện game arena
    characterSelectionEl.style.display = 'none';
    opponentSelectionEl.style.display = 'none'; // Hide opponent selection
    topicSelectionEl.style.display = 'none';
    gameArenaEl.style.display = 'flex';

    // Cập nhật hình ảnh nhân vật và đối thủ trong battle stage
    playerBattleCharEl.src = characterImages[playerCharacter];
    opponentBattleCharEl.src = currentOpponent.img;
    
    opponentHealth = currentOpponent.maxHealth; // Thiết lập máu đối thủ theo đối thủ đã chọn
    resetHealth(); // Đặt lại máu cho cả hai
    consecutiveCorrectAnswers = 0; // Reset chuỗi đúng liên tiếp
    burnTurns = 0; // Reset hiệu ứng bỏng
    
    playerAnswered = false; // Reset trạng thái trả lời của người chơi
    opponentAnswered = false; // Reset trạng thái trả lời của đối thủ

    currentPlayerTurn = 'player'; // Bắt đầu với lượt người chơi
    updateTurnDisplay();
    showQuestionNew(); // Hiển thị câu hỏi mới
  }

// Chuẩn hóa chuỗi: bỏ khoảng trắng thừa, không phân biệt hoa thường
function normalize(str) {
  return str.toLowerCase().replace(/\s+/g, ' ').trim();
}

// Kiểm tra xem câu trả lời có đúng không (dùng normalize)
function isCorrectAnswer(userAnswer, correctAnswerString) {
  const user = normalize(userAnswer);
  const correctAnswers = correctAnswerString.split(',').map(ans => normalize(ans));
  return correctAnswers.includes(user);
}

// Hiển thị câu hỏi mới
function showQuestionNew() {
  // Nếu đã hết câu hỏi trong danh sách hiện tại, quay lại từ đầu
  if (currentQuestionIndex >= currentQuizList.length) {
    currentQuestionIndex = 0;
  }
  const question = currentQuizList[currentQuestionIndex];
  let questionHtml = `<p>${question.vi}</p>`;
  if (question.img) {
    questionHtml = `<img src="${question.img}" alt="${question.vi}" /><p>${question.vi}</p>`;
  }
  quizQuestionNewEl.innerHTML = questionHtml;
  answerInputNewEl.value = '';
  answerInputNewEl.focus();
  resultMessageNewEl.textContent = '';
  answerInputNewEl.disabled = false; // Đảm bảo input được kích hoạt
}

// Hàm tạo hiệu ứng tấn công
function createAttackEffect(attackerCharEl, targetCharEl, effectImg, effectAnim, isPlayerAttack) {
    const effect = document.createElement('div');
    effect.className = 'skill-effect';
    effect.style.backgroundImage = `url('${effectImg}')`;
    effect.style.animation = `${effectAnim} 0.7s linear forwards`; // forwards để giữ trạng thái cuối animation

    // Tính toán vị trí xuất phát của hiệu ứng
    const attackerRect = attackerCharEl.getBoundingClientRect();
    const battleStageRect = document.getElementById('battle-stage').getBoundingClientRect();

    if (isPlayerAttack) {
        effect.style.left = `${attackerRect.left - battleStageRect.left + attackerRect.width / 2}px`;
        effect.style.top = `${attackerRect.top - battleStageRect.top + attackerRect.height / 2}px`;
    } else {
        // Đối thủ tấn công, hiệu ứng xuất phát từ bên phải
        effect.style.right = `${battleStageRect.width - (attackerRect.right - battleStageRect.left) + attackerRect.width / 2}px`;
        effect.style.top = `${attackerRect.top - battleStageRect.top + attackerRect.height / 2}px`;
    }
    
    document.getElementById('battle-stage').appendChild(effect);

    setTimeout(() => {
        effect.remove();
    }, 700); // Xóa hiệu ứng sau khi animation kết thúc
}

// Kiểm tra câu trả lời của người chơi
function checkAnswerNew() {
  const userAnswer = answerInputNewEl.value;
  if (!userAnswer.trim()) return;

  const correctAnswerString = currentQuizList[currentQuestionIndex].en;
  let baseDamage = 15; // Sát thương cơ bản của người chơi

  if (isCorrectAnswer(userAnswer, correctAnswerString)) {
    // Trả lời đúng
    resultMessageNewEl.textContent = 'Đúng rồi! Bạn tấn công đối thủ.';
    resultMessageNewEl.classList.remove('flash-wrong');
    resultMessageNewEl.classList.add('flash-correct');
    applyScreenFlash('green'); // Nhấp nháy màn hình xanh

    consecutiveCorrectAnswers++; // Tăng chuỗi đúng liên tiếp
    checkConsecutiveBonus(); // Kiểm tra phần thưởng đúng liên tiếp

    // Áp dụng khả năng nhân vật khi trả lời đúng
    if (playerCharacter === "Swordsman") {
      baseDamage = characterSkills.Swordsman.onCorrect(baseDamage);
      createAttackEffect(playerBattleCharEl, opponentBattleCharEl, "img/sword_effect.png", "swordAttack", true);
      resultMessageNewEl.textContent += ` Kiếm sĩ gây thêm sát thương! (${baseDamage} DMG)`;
    } else if (playerCharacter === "Mage") {
      characterSkills.Mage.onCorrect(); // Mage hồi máu
      createAttackEffect(playerBattleCharEl, opponentBattleCharEl, "img/magic_effect.png", "magicAttack", true);
      resultMessageNewEl.textContent += ` Pháp sư hồi máu!`;
    } else if (playerCharacter === "Archer") {
      createAttackEffect(playerBattleCharEl, opponentBattleCharEl, "img/arrow_effect.png", "arrowAttack", true);
      characterSkills.Archer.onCorrect(baseDamage); // Archer có cơ hội tấn công 2 lần
    }
    
    // Hiệu ứng trúng đòn
    const opponentRect = opponentBattleCharEl.getBoundingClientRect();
    const battleStageRect = document.getElementById('battle-stage').getBoundingClientRect();
    const hitEffect = document.createElement('div');
    hitEffect.className = 'hit-effect';
    hitEffect.style.left = `${opponentRect.left - battleStageRect.left + opponentRect.width / 2 - 40}px`;
    hitEffect.style.top = `${opponentRect.top - battleStageRect.top + opponentRect.height / 2 - 40}px`;
    document.getElementById('battle-stage').appendChild(hitEffect);
    setTimeout(() => { hitEffect.remove(); }, 300);
    
    // Character animations
    playerBattleCharEl.classList.add('player-attack-anim');
    opponentBattleCharEl.classList.add('opponent-hit-anim');
    
    damageOpponent(baseDamage); // Người chơi gây sát thương
    
    // Kỹ năng của đối thủ khi bị tấn công (ví dụ: Giáp gai của Orc)
    if (currentOpponent.skill.onDamageTaken) {
        currentOpponent.skill.onDamageTaken();
    }

  } else {
    // Trả lời sai
    resultMessageNewEl.textContent = 'Sai rồi! Đối thủ tấn công bạn.';
    resultMessageNewEl.classList.remove('flash-correct');
    resultMessageNewEl.classList.add('flash-wrong');
    applyScreenFlash('red'); // Nhấp nháy màn hình đỏ

    consecutiveCorrectAnswers = 0; // Reset chuỗi đúng liên tiếp
    let damageTaken = currentOpponent.baseDamage; // Sát thương người chơi nhận từ quái vật hiện tại
    
    // Kỹ năng của đối thủ khi người chơi trả lời sai (ví dụ: Phản đòn yếu của Slime)
    if (currentOpponent.skill.onWrongAnswer) {
        currentOpponent.skill.onWrongAnswer();
    }

    // Animation tấn công của đối thủ và hiệu ứng trúng đòn của người chơi
    opponentBattleCharEl.classList.add('opponent-attack-anim');
    playerBattleCharEl.classList.add('player-hit-anim');

    // Hiệu ứng tấn công của đối thủ
    createAttackEffect(opponentBattleCharEl, playerBattleCharEl, currentOpponent.skill.effectImg, currentOpponent.skill.effectAnim, false);

    // Hiệu ứng trúng đòn
    const playerRect = playerBattleCharEl.getBoundingClientRect();
    const battleStageRect = document.getElementById('battle-stage').getBoundingClientRect();
    const hitEffect = document.createElement('div');
    hitEffect.className = 'hit-effect';
    hitEffect.style.left = `${playerRect.left - battleStageRect.left + playerRect.width / 2 - 40}px`;
    hitEffect.style.top = `${playerRect.top - battleStageRect.top + playerRect.height / 2 - 40}px`;
    document.getElementById('battle-stage').appendChild(hitEffect);
    setTimeout(() => { hitEffect.remove(); }, 300);

    damagePlayer(damageTaken); // Người chơi bị sát thương
  }

  playerAnswered = true; // Đánh dấu người chơi đã trả lời

  // Delay 1.5s rồi chuyển lượt hoặc kết thúc game
  setTimeout(() => {
    resultMessageNewEl.classList.remove('flash-correct', 'flash-wrong');
    removeScreenFlash();
    
    playerBattleCharEl.classList.remove('player-attack-anim');
    opponentBattleCharEl.classList.remove('opponent-attack-anim');
    playerBattleCharEl.classList.remove('player-hit-anim');
    opponentBattleCharEl.classList.remove('opponent-hit-anim');

    checkGameEnd();
    if (!gameEnded) {
      switchTurn();
    }
  }, 1500);
}

// Hàm AI trả lời
function opponentTurn() {
  updateTurnDisplay();
  answerInputNewEl.disabled = true;

  setTimeout(() => {
    const correctAnswerString = currentQuizList[currentQuestionIndex].en;
    const possibleAnswers = correctAnswerString.split(',').map(ans => normalize(ans));

    let aiIsCorrect = Math.random() < currentOpponent.aiAccuracy; // Sử dụng độ chính xác của đối thủ

    let aiAnswer = "";
    if (aiIsCorrect) {
      aiAnswer = possibleAnswers[0];
      resultMessageNewEl.textContent = 'Đối thủ trả lời đúng! Bạn bị tấn công.';
      resultMessageNewEl.classList.remove('flash-wrong');
      resultMessageNewEl.classList.add('flash-correct');
      applyScreenFlash('red');

      let damageToPlayer = currentOpponent.baseDamage;
      if (playerCharacter === "SpiritBeast") {
        damageToPlayer = characterSkills.SpiritBeast.onDamageTaken(damageToPlayer);
        resultMessageNewEl.textContent += ` Rồng giảm sát thương! (${damageToPlayer.toFixed(0)} DMG)`;
      }
      
      // Kỹ năng của đối thủ khi trả lời đúng (ví dụ: Hơi thở rồng của Dragon, Tấn công nhanh của Goblin)
      if (currentOpponent.skill.onCorrectAnswer) {
          currentOpponent.skill.onCorrectAnswer();
      }

      // Hiệu ứng tấn công của đối thủ
      createAttackEffect(opponentBattleCharEl, playerBattleCharEl, currentOpponent.skill.effectImg, currentOpponent.skill.effectAnim, false);
      
      // Hiệu ứng trúng đòn
      const playerRect = playerBattleCharEl.getBoundingClientRect();
      const battleStageRect = document.getElementById('battle-stage').getBoundingClientRect();
      const hitEffect = document.createElement('div');
      hitEffect.className = 'hit-effect';
      hitEffect.style.left = `${playerRect.left - battleStageRect.left + playerRect.width / 2 - 40}px`;
      hitEffect.style.top = `${playerRect.top - battleStageRect.top + playerRect.height / 2 - 40}px`;
      document.getElementById('battle-stage').appendChild(hitEffect);
      setTimeout(() => { hitEffect.remove(); }, 300);

      opponentBattleCharEl.classList.add('opponent-attack-anim');
      playerBattleCharEl.classList.add('player-hit-anim');

      damagePlayer(damageToPlayer);
    } else {
      aiAnswer = "sai roi";
      resultMessageNewEl.textContent = 'Đối thủ trả lời sai! Đối thủ tự gây sát thương.';
      resultMessageNewEl.classList.remove('flash-correct');
      resultMessageNewEl.classList.add('flash-wrong');
      applyScreenFlash('green');
      
      opponentBattleCharEl.classList.add('opponent-hit-anim');
      
      const opponentRect = opponentBattleCharEl.getBoundingClientRect();
      const battleStageRect = document.getElementById('battle-stage').getBoundingClientRect();
      const hitEffect = document.createElement('div');
      hitEffect.className = 'hit-effect';
      hitEffect.style.left = `${opponentRect.left - battleStageRect.left + opponentRect.width / 2 - 40}px`;
      hitEffect.style.top = `${opponentRect.top - battleStageRect.top + opponentRect.height / 2 - 40}px`;
      document.getElementById('battle-stage').appendChild(hitEffect);
      setTimeout(() => { hitEffect.remove(); }, 300);

      damageOpponent(10); // AI tự gây sát thương
    }
    answerInputNewEl.value = aiAnswer;

    opponentAnswered = true; // Đánh dấu đối thủ đã trả lời

    setTimeout(() => {
      resultMessageNewEl.classList.remove('flash-correct', 'flash-wrong');
      removeScreenFlash();

      playerBattleCharEl.classList.remove('player-attack-anim');
      opponentBattleCharEl.classList.remove('opponent-attack-anim');
      playerBattleCharEl.classList.remove('player-hit-anim');
      opponentBattleCharEl.classList.remove('opponent-hit-anim');

      checkGameEnd();
      if (!gameEnded) {
        switchTurn();
      }
    }, 1500);
  }, 1000);
}

// Hàm chuyển lượt
function switchTurn() {
  // Kiểm tra hiệu ứng bỏng trước khi chuyển lượt
  checkBurnEffect();

  if (gameEnded) return; // Nếu game đã kết thúc do hiệu ứng bỏng

  if (currentPlayerTurn === 'player') {
    // Nếu người chơi đã trả lời, chuyển sang lượt đối thủ
    if (playerAnswered) {
      currentPlayerTurn = 'opponent';
      playerAnswered = false; // Reset trạng thái người chơi đã trả lời
      opponentTurn();
    } else {
      // Nếu người chơi chưa trả lời (ví dụ: sau khi hiệu ứng bỏng), vẫn là lượt người chơi
      updateTurnDisplay();
      showQuestionNew(); // Hiển thị lại câu hỏi hiện tại cho người chơi
    }
  } else { // currentPlayerTurn === 'opponent'
    // Nếu đối thủ đã trả lời, chuyển sang câu hỏi tiếp theo và lượt người chơi
    if (opponentAnswered) {
      currentQuestionIndex++; // Chuyển sang câu hỏi tiếp theo
      currentPlayerTurn = 'player';
      opponentAnswered = false; // Reset trạng thái đối thủ đã trả lời
      updateTurnDisplay();
      showQuestionNew();
    } else {
      // Nếu đối thủ chưa trả lời (ví dụ: sau khi hiệu ứng bỏng), vẫn là lượt đối thủ
      opponentTurn(); // Gọi lại lượt đối thủ
    }
  }
}

// Cập nhật hiển thị lượt
function updateTurnDisplay() {
  currentTurnEl.textContent = `Lượt của ${currentPlayerTurn === 'player' ? 'Bạn' : currentOpponent.name}`;
}

// Giảm HP người chơi
function damagePlayer(dmg) {
  playerHealth -= dmg;
  if (playerHealth < 0) playerHealth = 0;
  updateHealthBars();
}

// Hồi máu cho người chơi
function healPlayer(amount) {
  playerHealth += amount;
  if (playerHealth > maxHealth) playerHealth = maxHealth;
  updateHealthBars();
}

// Giảm HP đối thủ
function damageOpponent(dmg) {
  opponentHealth -= dmg;
  if (opponentHealth < 0) opponentHealth = 0;
  updateHealthBars();
}

// Cập nhật thanh máu
function updateHealthBars() {
  playerHealthBarEl.style.width = (playerHealth / maxHealth * 100) + '%';
  playerHealthTextEl.textContent = `${playerHealth}/${maxHealth}`;
  opponentHealthBarEl.style.width = (opponentHealth / currentOpponent.maxHealth * 100) + '%';
  opponentHealthTextEl.textContent = `${opponentHealth}/${currentOpponent.maxHealth}`;
}

// Reset máu về full
function resetHealth() {
  playerHealth = maxHealth;
  opponentHealth = currentOpponent.maxHealth;
  updateHealthBars();
}

// Kiểm tra kết thúc game
function checkGameEnd() {
  if (playerHealth <= 0) {
    alert('Bạn đã bị đánh bại! Trận đấu kết thúc.');
    gameEnded = true;
    resetGame();
  } else if (opponentHealth <= 0) {
    alert(`Bạn đã chiến thắng ${currentOpponent.name}!`);
    gameEnded = true; // Đặt gameEnded để resetGame được gọi
    resetGame(); // Reset game về màn hình chọn đối thủ
  }
  // Bỏ điều kiện hết câu hỏi để game chỉ kết thúc khi hết máu
}

// Hàm đầu hàng
function surrenderGame() {
  if(confirm('Bạn có chắc muốn đầu hàng?')){
    alert('Bạn đã đầu hàng! Trận đấu kết thúc.');
    gameEnded = true;
    resetGame();
  }
}

// Reset game về chọn nhân vật
function resetGame() {
  gameArenaEl.style.display = 'none';
  topicSelectionEl.style.display = 'none';
  opponentSelectionEl.style.display = 'none'; // Hide opponent selection
  characterSelectionEl.style.display = 'flex'; // Show character selection

  skillInfoDisplayEl.style.display = 'none';
  opponentSkillInfoDisplayEl.style.display = 'none'; // Hide opponent skill info
  btnContinueChar.style.display = 'none';
  btnContinueOpponent.style.display = 'none'; // Hide opponent continue button

  currentCharacter = null;
  playerCharacter = null;
  selectedOpponentType = null;
  currentOpponent = null;
  currentTopic = null;
  currentQuestionIndex = 0;
  playerHealth = maxHealth;
  opponentHealth = 0; // Reset to 0, will be set when opponent is chosen
  currentPlayerTurn = 'player';
  gameEnded = false;
  consecutiveCorrectAnswers = 0;
  burnTurns = 0;
  playerAnswered = false; // Reset trạng thái
  opponentAnswered = false; // Reset trạng thái

  characterSelectionEl.querySelectorAll('.character').forEach(c => c.classList.remove('selected'));
  opponentSelectionEl.querySelectorAll('.opponent').forEach(c => c.classList.remove('selected'));
}

// Nút "Tiếp tục" cho chọn nhân vật
const btnContinueChar = document.createElement('button');
btnContinueChar.textContent = 'Tiếp tục → Chọn Đối Thủ';
btnContinueChar.style.marginTop = '25px';
btnContinueChar.style.fontWeight = 'bold';
btnContinueChar.style.backgroundColor = '#00bfff';
btnContinueChar.style.color = 'white';
btnContinueChar.style.border = 'none';
btnContinueChar.style.borderRadius = '12px';
btnContinueChar.style.padding = '12px 25px';
btnContinueChar.style.cursor = 'pointer';
btnContinueChar.style.boxShadow = '0 4px 8px rgba(0, 191, 255, 0.4)';
btnContinueChar.style.display = 'none';
btnContinueChar.addEventListener('click', () => {
  if (!currentCharacter) {
    alert('Vui lòng chọn nhân vật trước!');
    return;
  }
  characterSelectionEl.style.display = 'none';
  skillInfoDisplayEl.style.display = 'none'; // Hide player skill info
  btnContinueChar.style.display = 'none'; // Hide player continue button
  opponentSelectionEl.style.display = 'flex'; // Show opponent selection
});
characterSelectionEl.appendChild(btnContinueChar);

// Nút "Tiếp tục" cho chọn đối thủ
const btnContinueOpponent = document.createElement('button');
btnContinueOpponent.textContent = 'Tiếp tục → Chọn Chủ Đề';
btnContinueOpponent.style.marginTop = '25px';
btnContinueOpponent.style.fontWeight = 'bold';
btnContinueOpponent.style.backgroundColor = '#ff4500'; // Màu đỏ cam
btnContinueOpponent.style.color = 'white';
btnContinueOpponent.style.border = 'none';
btnContinueOpponent.style.borderRadius = '12px';
btnContinueOpponent.style.padding = '12px 25px';
btnContinueOpponent.style.cursor = 'pointer';
btnContinueOpponent.style.boxShadow = '0 4px 8px rgba(255, 69, 0, 0.4)';
btnContinueOpponent.style.display = 'none';
btnContinueOpponent.addEventListener('click', () => {
  if (!selectedOpponentType) {
    alert('Vui lòng chọn đối thủ trước!');
    return;
  }
  opponentSelectionEl.style.display = 'none';
  opponentSkillInfoDisplayEl.style.display = 'none'; // Hide opponent skill info
  btnContinueOpponent.style.display = 'none'; // Hide opponent continue button
  topicSelectionEl.style.display = 'block'; // Show topic selection
});
opponentSelectionEl.appendChild(btnContinueOpponent);


// Hàm trộn mảng
function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    let j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

// Hàm nhấp nháy màn hình
function applyScreenFlash(color) {
  if (color === 'green') {
    bodyEl.classList.add('screen-flash-green');
  } else if (color === 'red') {
    bodyEl.classList.add('screen-flash-red');
  }
}

// Hàm xóa nhấp nháy màn hình
function removeScreenFlash() {
  bodyEl.classList.remove('screen-flash-green', 'screen-flash-red');
}

// Hàm kiểm tra và áp dụng phần thưởng đúng liên tiếp
function checkConsecutiveBonus() {
  if (consecutiveCorrectAnswers > 0 && consecutiveCorrectAnswers % CONSECUTIVE_BONUS_THRESHOLD === 0) {
    const bonusAmount = 15; // Máu hồi hoặc sát thương thêm
    resultMessageNewEl.textContent += ` Bạn đã trả lời đúng ${consecutiveCorrectAnswers} câu liên tiếp! Nhận thưởng!`;
    
    // Ví dụ thưởng: Hồi máu cho người chơi
    healPlayer(bonusAmount);
    resultMessageNewEl.textContent += ` (+${bonusAmount} máu)`;

    // Có thể thêm các loại thưởng khác tùy theo nhân vật hoặc ngẫu nhiên
    // if (playerCharacter === "Swordsman") {
    //   damageOpponent(bonusAmount); // Gây thêm sát thương
    //   resultMessageNewEl.textContent += ` (+${bonusAmount} sát thương)`;
    // }
  }
}
</script>

</body>
</html>
